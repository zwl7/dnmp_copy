{"version":3,"file":"javaRequest.js","sources":["../../../../../src/apis/sportsService/javaRequest.js"],"sourcesContent":["import config from '@/core/config'\nimport { getToken, setToken, removeToken, getUserInfoKeySync } from '@/utils/token.js'\nimport w_md5 from '@/utils/thirdPartUtils/md5.js'\n\nlet isRefreshing = true\nlet loginCompelete = false\nlet subscribers = []\nlet loginCount = 0\n\nfunction onAccessTokenFetched() {\n  console.log('----回调函数', subscribers)\n  subscribers.forEach((callback) => {\n    callback()\n  })\n  subscribers = []\n}\n\nfunction addSubscriber(callback) {\n  subscribers.push(callback)\n}\nuni.$on('GLOBAL_SAVETOKEN', () => {\n  console.log('----GLOBAL_SAVETOKEN')\n  onAccessTokenFetched()\n})\n\nfunction getUrl(url) {\n  let reg = new RegExp('http')\n  let flag = reg.test(url)\n  if (flag) {\n    return url\n  } else {\n    return config.baseUrl + url\n  }\n}\nasync function request({ url, data = {}, header, callback = '', method = 'POST' } = {}) {\n  let isLogin = data.is_login === 1\n  let token = ''\n  try {\n    token = await getToken(true)\n  } catch (error) {}\n  url = getUrl(url)\n  var user_info = {}\n  try {\n    let user = getUserInfoKeySync()\n    if (user) {\n      user_info.latitude = user.latitude\n      user_info.longitude = user.longitude\n    }\n  } catch (error) {\n    console.error('user_info', error)\n  }\n  if (data.authorizationToken) {\n    token = data.authorizationToken\n    delete data.authorizationToken\n  }\n  let request_id = w_md5.hex_md5_32(`${new Date().getTime()}${Math.random()}${token}`)\n\n  data = Object.assign(\n    {\n      company_id: config.company_id,\n      business_id: config.business_id,\n      request_id: request_id,\n    },\n    user_info,\n    data,\n  )\n\n  if (url.indexOf('pay') != -1 || url.indexOf('wxMenu') != -1) {\n    delete data.business_id\n    delete data.company_id\n  }\n\n  return new Promise((resolve, reject) => {\n    if (!token) {\n      addSubscriber(() => {\n        request({\n          url,\n          data,\n          method,\n          header,\n          callback: resolve,\n        })\n      })\n      return\n    }\n    uni.request({\n      url,\n      data,\n      method,\n      header: {\n        Authorization: token,\n        'content-type': 'application/json;charset=utf-8',\n        Origin: config.baseUrl.split('://')[1],\n        channel: 'wx',\n      },\n      callback,\n      fail(res) {\n        reject(res)\n      },\n      complete: (res) => {\n        if ((callback && res.data.code === 0) || (callback && loginCount > 10)) {\n          return callback(res.data)\n        }\n        let statusCode = res.statusCode\n        if (statusCode == 404) {\n        } else if (statusCode == 401) {\n        } else if (statusCode == 200) {\n          if (isLogin) {\n            loginCompelete = true\n            console.log('---定时器')\n            let user_info = {\n              member_id: res.data.data.account_id,\n              business_id: res.data.data.business_id,\n            }\n            removeToken(res.data.data.token, true).then((c) => {})\n            onAccessTokenFetched()\n          }\n          // 错误码不明确 下单的 也是\n          if (res.data.code === 40114 || res.data.code === 40101) {\n            if (data.city_id) {\n              delete data.city_id\n            }\n            loginCount += 1\n            addSubscriber(() => {\n              request({\n                url,\n                data,\n                method,\n                header,\n                callback: resolve,\n              })\n            })\n            clearToken()\n            if (isRefreshing) {\n              getNewToken().then(() => {\n                onAccessTokenFetched()\n                isRefreshing = true\n              })\n            }\n            isRefreshing = false\n            return\n          }\n          resolve(res.data)\n        } else if (statusCode.startsWith('5')) {\n          uni.showModal({\n            content: '服务器报错，请重试！',\n            showCancel: false,\n          })\n        }\n      },\n    })\n  })\n}\n\nfunction getWxCode() {\n  return new Promise((resolve, reject) => {\n    uni.login({\n      provider: 'weixin',\n      success(res) {\n        resolve(res)\n      },\n      fail() {\n        reject('faily get wxcode')\n      },\n    })\n  })\n}\n// 获取token\nconst getNewToken = () => {\n  return new Promise(async (resolve, reject) => {\n    let res = await getWxCode()\n    let { code } = res\n    request({\n      url: '/infoPlatform/wxMember/miniLogin',\n      data: {\n        code,\n        company_id: config.company_id,\n        is_login: 1,\n      },\n    }).then((res) => {\n      if (res.code === 200) {\n        setToken(res.data.token, true).then((c) => {\n          console.log('----获取token2', c)\n          resolve(res)\n        })\n      } else {\n        console.log('----获取token3', res)\n        reject(res)\n      }\n    })\n  })\n}\n\nexport default request\n"],"names":["uni","config","getToken","getUserInfoKeySync","w_md5","removeToken","res","setToken"],"mappings":"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"}