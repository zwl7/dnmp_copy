{"version":3,"file":"index.js","sources":["../../../../../src/store/user/index.js"],"sourcesContent":["import { defineStore } from 'pinia'\nimport {\n  getToken,\n  removeToken,\n  setToken,\n  setIsLogin,\n  getIsLogin,\n  removeIsLogin,\n} from '@/utils/token'\nimport { getH5MemberInfo, getWxMemberInfo, getTokenNoLogin } from '@/apis/user/index'\nimport uniStorage from '@/utils/storages/uniStorage'\nimport { isMp } from '@/utils/platform'\nimport { UserLoginClass } from './login'\nimport { getCommonEnum } from '@/apis/sportsService/common'\nimport { getToDoData } from '@/apis/sportsService/common'\nimport { sportServiceMenu, sportManageMenu, sportOtherMenu } from '@/configs/sprosServiceMenu'\nexport const useUserStore = defineStore('app-user', {\n  state() {\n    return {\n      userInfo: {},\n      isLogin: getIsLogin(), // 是否登陆\n      token: getToken(),\n      enumMap: {},\n      userTodoCenterData: {}, // 用户待办中心数据\n    }\n  },\n  getters: {\n    userId: (state) => state.userInfo?.userId,\n    avatar: (state) => state.userInfo?.avatar,\n    nick_name: (state) => state.userInfo?.nick_name,\n    isAuthInstructor: (state) => state.userInfo.is_auth_instructor, // 是否认证社体指导员\n    resumed: (state) => !!state.resumeInfo.id,\n    userTypesGetter() {\n      return this.userInfo.authTypes\n    },\n    // 健身服务菜单\n    sportServiceMenuGetter() {\n      return (\n        sportServiceMenu.filter((item) => {\n          return this.checkMenuAuth(item.auth, item.isShowMenu)\n        }) || []\n      )\n    },\n    // 服务管理菜单\n    sportManageMenuGetter() {\n      return (\n        sportManageMenu.filter((item) => {\n          return this.checkMenuAuth(item.auth, item.isShowMenu)\n        }) || []\n      )\n    },\n    // 其他菜单\n    sportOtherMenuGetter() {\n      return sportOtherMenu.filter((item) => this.checkMenuAuth(item.auth, item.isShowMenu)) || []\n    },\n  },\n  actions: {\n    removeToken() {\n      this.token = ''\n      removeToken()\n    },\n    setToken(token) {\n      this.token = token\n      setToken(token)\n    },\n    _setIsLogin(isLogin) {\n      this.isLogin = isLogin\n      setIsLogin(isLogin)\n      uni.$emit('GET_USER_INFO', {\n        isLogin: isLogin,\n      })\n    },\n    // 获取用户详情\n    async getUserInfo(params = {}) {\n      let res = {}\n      try {\n        if (isMp) {\n          res = await getWxMemberInfo(params)\n          console.log('获取用户信---息', res)\n        } else {\n          res = await getH5MemberInfo(params)\n        }\n        if (res.code !== 200) {\n          throw new Error(res.message)\n        }\n      } catch (error) {\n        console.log('获取用户信息失败', error)\n        throw new Error(error)\n      }\n      if (!res?.data) {\n        throw new Error('获取用户信息失败, 没有获取到数据')\n      }\n      const data = res.data\n      let instructor_info = {}\n      if (Object.prototype.toString.call(data.instructor_info) == '[object Object]') {\n        instructor_info = data.instructor_info\n      }\n      let baseInstructor = instructor_info.rs ? instructor_info.rs : {}\n      this.userInfo = {\n        ...instructor_info,\n        ...data,\n        instructor_info,\n        instructor_id: data.instructor_id,\n        userId: data.id,\n        avatar: data.avatar,\n        avatar_url: data.avatar_url,\n        nick_name: baseInstructor.name ? baseInstructor.name : '微信用户',\n        tag_ids_arr: baseInstructor.tag_ids_arr ? baseInstructor.tag_ids_arr : [],\n        level: baseInstructor.level,\n        star_level: baseInstructor.star_level ? baseInstructor.star_level : '',\n        level_str: baseInstructor.level_str ? baseInstructor.level_str : '',\n        is_auth_instructor: data.instructor_id > 0 ? 1 : 0,\n        is_auth: data.is_authenticate,\n        is_authenticate: data.is_authenticate,\n      }\n      this.setUserInfo(this.userInfo)\n      getApp().globalData.userInfo = this.userInfo\n      return this.userInfo\n    },\n    // 获取临时token\n    async getTokenNoLogin() {\n      const userLoginClass = new UserLoginClass()\n      const res = await userLoginClass.getTemporaryToken()\n      this.setToken(res.token)\n      this._setIsLogin(res.is_login)\n      return res.data\n    },\n\n    logout({ silenced = false, redirect = null } = {}) {\n      this.removeToken()\n      this.userInfo = {}\n      this.resumeInfo = {}\n      this._setIsLogin(false)\n      if (!silenced) {\n        uni.reLaunch({\n          url: '/pages/tabbar/home/index',\n        })\n      }\n    },\n\n    // 获取用户待办中心数据\n    async getUserTodoCenterData() {\n      const res = await getToDoData({})\n      if (res.code === 0) {\n        if (Object.prototype.toString.call(res.data) === '[object Object]') {\n          let obj = {}\n          Object.keys(res.data).forEach((key) => {\n            obj[key] = res.data[key] > 99 ? '99+' : res.data[key]\n          })\n          this.userTodoCenterData = obj\n        }\n      }\n    },\n    // 枚举逻辑\n    setUserInfo(userData) {\n      // 更新权限\n      console.log({ userData })\n      const map = {\n        999: 'platformManager', // 1平台管理员\n        1: 'orgManager', // 2.组织管理员\n        2: 'siteManager', // 3.站点管理员\n        998: 'sprotsTalent', // 4.体育人才\n      }\n      userData.authTypes = userData.auth?.map((item) => map[item.type]).filter((item) => item)\n      this.userInfo = userData\n    },\n    checkMenuAuth(authList, isShowMenu = true) {\n      if (!isShowMenu) return false\n      if (!Array.isArray(authList) || authList.length == 0) return true\n      let flag = false\n      if (this.userInfo.authTypes && this.userInfo.authTypes.length > 0) {\n        authList.forEach((item) => {\n          if (this.userInfo.authTypes.includes(item)) {\n            flag = true\n          }\n        })\n      }\n      return flag\n    },\n    // 枚举逻辑\n    setEnumMap(value) {\n      this.enumMap = value\n    },\n    getEnumObjByKey(key) {\n      let list = this.enumMap[key]\n      let obj = {}\n      if (list) {\n        list.forEach((e) => {\n          obj[e.value] = e.label\n        })\n      }\n      return obj\n    },\n    getEnumListByKey(key) {\n      return this.enumMap[key]\n    },\n    async getCommonEnumFn() {\n      console.log('获取枚举')\n      let res = await getCommonEnum()\n      console.log('获取枚举', { res })\n      if (res.code != 0) {\n        return console.error(res)\n      }\n      let enumMapCopy = {}\n      res.data.map((e) => {\n        let list = e.enumVal.map((c) => {\n          return {\n            label: c.desc,\n            value: c.value,\n          }\n        })\n        enumMapCopy[e.key] = list\n      })\n      console.log({ enumMapCopy })\n      this.setEnumMap(enumMapCopy)\n      return enumMapCopy\n    },\n  },\n})\n"],"names":["defineStore","getIsLogin","getToken","sportServiceMenu","sportManageMenu","sportOtherMenu","removeToken","setToken","setIsLogin","uni","isMp","getWxMemberInfo","getH5MemberInfo","UserLoginClass","getToDoData","getCommonEnum"],"mappings":"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"}